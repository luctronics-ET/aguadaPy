# Sistema Supervis√≥rio H√≠drico IoT - CMMS/BMS √Ågua

## Vis√£o Geral

Sistema inteligente de monitoramento e gest√£o de rede h√≠drica com foco em:
- **Redu√ß√£o de dados** atrav√©s de compress√£o inteligente (delta logging + deadband filtering)
- **Detec√ß√£o autom√°tica** de eventos (abastecimento, consumo, vazamento)
- **Rastreabilidade completa** (sensor/usu√°rio/sistema + timestamp)
- **Visualiza√ß√£o espacial** com mapas interativos
- **Relat√≥rios di√°rios** autom√°ticos √†s 06:00

## Caracter√≠sticas do Sistema

### Infraestrutura Atual
- **6 reservat√≥rios** (consumo, inc√™ndio, elevados)
- **5-10 bombas** de recalque
- **~20 v√°lvulas** de controle
- **Sensores ultrass√¥nicos** (ESP32) lendo a cada 30s
- **Leituras manuais** de hidr√¥metros

### Tecnologias Principais

#### Hardware IoT
- **ESP32-C3 Super Mini**: baixo custo, WiFi integrado, ideal para sensores distribu√≠dos
- **Arduino Nano**: controle de atuadores e sensores secund√°rios
- **Sensores**: HC-SR04 (ultrassom), sensores de press√£o, vaz√£o

#### Protocolos de Comunica√ß√£o
- **ESP-NOW**: comunica√ß√£o mesh entre dispositivos, baixa lat√™ncia
- **WiFi**: envio de dados ao servidor central
- **Ethernet**: conex√£o redundante para sistemas cr√≠ticos
- **I¬≤C/1-Wire**: comunica√ß√£o com sensores locais

#### Backend
- **PostgreSQL 13+** com extens√µes:
  - **TimescaleDB**: otimiza√ß√£o para s√©ries temporais
  - **PostGIS**: suporte geoespacial (opcional)
- **PL/pgSQL**: l√≥gica de compress√£o e processamento
- **Node.js/Python**: API REST e processamento ass√≠ncrono

#### Frontend
- **Leaflet.js**: mapas interativos com posicionamento de elementos
- **Chart.js/D3.js**: gr√°ficos em tempo real
- **WebSocket**: atualiza√ß√£o live de estados

## Arquitetura de Dados

### Modelo de Compress√£o Inteligente

#### Camada RAW (leituras_raw)
```sql
- Armazena TODAS as leituras brutas
- Campos: sensor_id, timestamp, valor_bruto, origem
- Preserva hist√≥rico completo para auditoria
- M√©dia: 2880 registros/dia por sensor (30s)
```

#### Camada PROCESSADA (leituras_processadas)
```sql
- Armazena apenas MUDAN√áAS SIGNIFICATIVAS
- Algoritmo:
  * Calcula mediana de N leituras (padr√£o: 11)
  * Aplica deadband (toler√¢ncia: ¬±2cm ou configur√°vel)
  * Se est√°vel: atualiza timestamp, n√£o cria novo registro
  * Se mudan√ßa: insere novo evento
- Redu√ß√£o: ~90% de dados
- Resultado: 5-10 eventos relevantes/dia
```

### Estrutura Principal

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ELEMENTO   ‚îÇ  ‚Üê Reservat√≥rios, Bombas, V√°lvulas
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ id          ‚îÇ
‚îÇ nome        ‚îÇ
‚îÇ tipo        ‚îÇ
‚îÇ coord_x/y/z ‚îÇ  ‚Üê Posicionamento espacial
‚îÇ lat/lon     ‚îÇ  ‚Üê Geolocaliza√ß√£o
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚îÇ
      ‚îú‚îÄ‚îÄ‚Üí CONEXAO (grafo hidr√°ulico)
      ‚îú‚îÄ‚îÄ‚Üí SENSOR (leituras)
      ‚îú‚îÄ‚îÄ‚Üí ATUADOR (controle)
      ‚îú‚îÄ‚îÄ‚Üí ESTADO_ELEMENTO (hist√≥rico)
      ‚îî‚îÄ‚îÄ‚Üí COORDENADA (visualiza√ß√£o)
```

## Eventos Detectados Automaticamente

### 1. ABASTECIMENTO
```
Condi√ß√µes:
- ŒîVolume > +50L
- Bomba = ON
- V√°lvula entrada = ABERTA
A√ß√£o: Registra in√≠cio, fim, volume total, dura√ß√£o
```

### 2. VAZAMENTO
```
Condi√ß√µes:
- Queda lenta cont√≠nua (> 1h)
- Bombas = OFF
- V√°lvulas consumo = FECHADAS
- Taxa > limiar (ex: -15 L/h)
A√ß√£o: Alerta, c√°lculo de perda estimada
```

### 3. CONSUMO
```
Condi√ß√µes:
- Queda correlacionada com demanda
- Bombas consumo = ON ou padr√£o hor√°rio
A√ß√£o: Registra volume consumido
```

### 4. SENSOR RUIDOSO
```
Condi√ß√µes:
- Oscila√ß√£o > 3√ó desvio padr√£o normal
- Valores fora do range f√≠sico
A√ß√£o: Marca para calibra√ß√£o
```

## Fluxo de Dados

```
[ESP32] --30s--> [leituras_raw] --trigger--> [proc_process_sensor_window()]
                                                    ‚îÇ
                                                    ‚îú‚îÄ calcula mediana
                                                    ‚îú‚îÄ verifica deadband
                                                    ‚îú‚îÄ detecta eventos
                                                    ‚îî‚îÄ atualiza [leituras_processadas]
                                                           ‚îÇ
                                                           ‚îî‚îÄ> [Dashboard em Tempo Real]
                                                           ‚îî‚îÄ> [Relat√≥rio Di√°rio 06:00]
```

## Funcionalidades Principais

### 1. Monitoramento em Tempo Real
- N√≠veis de todos os reservat√≥rios
- Estados de bombas e v√°lvulas
- Alertas instant√¢neos
- Hist√≥rico de eventos

### 2. Mapa Interativo
- Visualiza√ß√£o espacial de todos os elementos
- Cores por estado (verde=OK, amarelo=alerta, vermelho=cr√≠tico)
- Conex√µes hidr√°ulicas desenhadas
- Clique para detalhes e hist√≥rico

### 3. Rastreabilidade Total
```sql
Cada registro cont√©m:
- fonte: 'sensor' | 'usuario' | 'sistema'
- autor: identifica√ß√£o (node_id, username, processo)
- datetime: timestamp preciso
- modo: 'automatica' | 'manual'
```

### 4. Calibra√ß√£o
- Interface para leitura manual
- Compara√ß√£o sensor vs. r√©gua f√≠sica
- Ajuste de offset e fator
- Log de calibra√ß√µes

### 5. Relat√≥rio Di√°rio (06:00)
```
Conte√∫do:
- Volume total consumido
- Volume total abastecido
- Eventos detectados
- Anomalias e alertas
- N√≠veis m√≠n/m√°x de cada reservat√≥rio
- Tempo de opera√ß√£o de bombas
- Perda estimada (vazamentos)

Formato: PDF + email + inser√ß√£o em BD
```

## üê≥ Deploy com Docker

O sistema est√° pronto para deploy via Docker! Veja o **[DOCKER_GUIDE.md](DOCKER_GUIDE.md)** para instru√ß√µes completas.

### Deploy R√°pido (PC isolado via pendrive)

```bash
# No PC atual (desenvolvimento)
./backup.sh /media/pendrive

# Copie para o PC de destino e execute
./restore.sh aguada_backup_YYYYMMDD_HHMMSS.tar.gz

# Pronto! Sistema rodando em:
# - Dashboard: http://localhost
# - API: http://localhost:3000
# - PostgreSQL: localhost:5432
```

### Gerenciar Sistema

```bash
./deploy.sh start    # Iniciar
./deploy.sh stop     # Parar
./deploy.sh restart  # Reiniciar
./deploy.sh logs     # Ver logs
./deploy.sh status   # Status dos containers
```

## üì° Firmwares Dispon√≠veis

Hardware j√° dispon√≠vel (sem necessidade de compra):
- ‚úÖ 2√ó ESP32 + HC-SR04 ultrassom
- ‚úÖ 1√ó Arduino Nano + Ethernet + HC-SR04
- ‚úÖ 1√ó ESP32-C3 Super Mini (gateway WiFi)
- ‚úÖ 1√ó ESP8266 + ENC28J60 (gateway backup)

Firmwares prontos em `/opt/lampp/htdocs/aguada/firmware/` (**somente leitura**):
- **NODE-01-CON**: ESP32 com ESP-NOW (n√≥s remotos)
- **NODE-02-CAV**: Arduino Nano + Ethernet (cr√≠tico)
- **GATEWAY_WIFI**: ESP32 gateway (WiFi + ESP-NOW)

üìñ Veja **[FIRMWARES_DISPONIVEIS.md](FIRMWARES_DISPONIVEIS.md)** para detalhes completos.

## üéØ Pr√≥ximos Passos

1. **Instalar Docker no PC de destino** (se n√£o tiver)
2. **Executar `./deploy.sh start`** (inicia PostgreSQL + Backend + Frontend)
3. **Copiar e adaptar firmwares** de `/aguada/firmware/` (apenas URLs/IPs)
4. **Configurar ESP32** com IP do servidor Docker
5. **Testar conectividade** sensor ‚Üí API

## Estrat√©gia de Desenvolvimento IoT

### Hardware Selecionado

| Dispositivo | Uso | Protocolo | Custo Aprox |
|-------------|-----|-----------|-------------|
| ESP32-C3 Super Mini | Sensores nivel | WiFi/ESP-NOW | R$ 15 |
| Arduino Nano | Controle local | I¬≤C/1-Wire | R$ 25 |
| HC-SR04 | Ultrassom | Digital | R$ 8 |
| Sensor Press√£o | Rede | Anal√≥gico | R$ 35 |

### Topologia de Rede

```
          [Servidor Central]
               ‚îÇ WiFi
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ          ‚îÇ          ‚îÇ
[ESP32_RES1] [ESP32_RES2] [ESP32_RES3]
    ‚îÇESP-NOW   ‚îÇESP-NOW   ‚îÇ
[ESP32_RES4] [ESP32_RES5] [ESP32_RES6]
```

### Firmware: Recursos

#### Medi√ß√£o Robusta
```cpp
// Mediana de 11 leituras para filtrar ru√≠do
float mediana = calcularMediana(leituras, 11);

// Enviar apenas se mudan√ßa > deadband
if (abs(mediana - ultimaLeitura) > DEADBAND) {
    enviarDados(mediana);
}
```

#### Economia de Energia
- Deep sleep entre leituras (30s)
- Wake on timer
- Consumo: ~5mA em sleep, ~80mA ativo

#### Redund√¢ncia
- Fallback WiFi ‚Üí ESP-NOW
- Buffer local (√∫ltimas 100 leituras)
- Ressincroniza√ß√£o autom√°tica

## Plano de Testes

### Fase 1: Unit√°rios
- [ ] Fun√ß√£o de mediana
- [ ] Algoritmo de deadband
- [ ] Detec√ß√£o de eventos
- [ ] Triggers SQL

### Fase 2: Integra√ß√£o
- [ ] ESP32 ‚Üí API ‚Üí BD
- [ ] Compress√£o autom√°tica
- [ ] Gera√ß√£o de relat√≥rio
- [ ] Calibra√ß√£o manual

### Fase 3: Campo
- [ ] 7 dias de monitoramento cont√≠nuo
- [ ] Valida√ß√£o de vazamentos detectados
- [ ] Compara√ß√£o hidr√¥metro vs. sensor
- [ ] Stress test (1000 leituras simult√¢neas)

## Implanta√ß√£o

### Cronograma Sugerido

| Semana | Atividade |
|--------|-----------|
| 1-2 | Setup banco de dados + API b√°sica |
| 3 | Firmware ESP32 + testes bancada |
| 4 | Instala√ß√£o de 2 sensores piloto |
| 5-6 | Dashboard e visualiza√ß√£o |
| 7 | Sistema de eventos e relat√≥rios |
| 8 | Implanta√ß√£o completa (6 reservat√≥rios) |
| 9+ | Monitoramento e ajustes finos |

## Manuten√ß√£o

### Preventiva
- **Mensal**: Verifica√ß√£o f√≠sica de sensores
- **Trimestral**: Calibra√ß√£o com r√©gua
- **Semestral**: Limpeza de sensores ultrass√¥nicos

### Corretiva
- Alertas autom√°ticos por email/Telegram
- Dashboard de sa√∫de dos sensores
- Log de erros centralizado

## Escalabilidade

### Atual (6 reservat√≥rios)
- Banco: PostgreSQL 13 em servidor local
- Storage: ~500 MB/ano (com compress√£o)
- CPU: m√≠nimo (triggers leves)

### Expans√£o (50+ reservat√≥rios)
- Migrar para TimescaleDB
- Particionamento por m√™s
- Compress√£o nativa TimescaleDB
- Cluster multi-node (se necess√°rio)

## An√°lise de Custos

### Hardware (estimativa para 6 reservat√≥rios)
```
6√ó ESP32-C3 Super Mini        = R$ 90
6√ó Sensor HC-SR04            = R$ 48
6√ó Fonte 5V + case           = R$ 120
Cabeamento e conectores      = R$ 80
                    TOTAL    = R$ 338
```

### Software
- PostgreSQL: gratuito (open source)
- Backend Node.js: gratuito
- Frontend: gratuito
- Servidor: existente

### Economia Estimada
- Redu√ß√£o de 90% em armazenamento
- Detec√ß√£o precoce de vazamentos ‚Üí economia de √°gua
- Automatiza√ß√£o de relat√≥rios ‚Üí redu√ß√£o de horas/homem

## Desafios e Solu√ß√µes

| Desafio | Solu√ß√£o |
|---------|---------|
| Ru√≠do em leituras ultrass√¥nicas | Mediana de 11 amostras + deadband |
| Leituras falsas de vazamento | Correla√ß√£o com estado de bombas/v√°lvulas |
| Falta de energia em sensores | Deep sleep + buffer local |
| Perda de conectividade WiFi | Fallback ESP-NOW mesh |
| Calibra√ß√£o deriva ao longo do tempo | Interface de calibra√ß√£o manual + log |

## Roadmap Futuro

### Curto Prazo (3 meses)
- [x] Modelo de dados completo
- [ ] Firmware ESP32 funcional
- [ ] API REST b√°sica
- [ ] Dashboard inicial

### M√©dio Prazo (6 meses)
- [ ] Machine Learning para predi√ß√£o de falhas
- [ ] App mobile (React Native)
- [ ] Integra√ß√£o com sistema de manuten√ß√£o
- [ ] Alertas inteligentes (Telegram/WhatsApp)

### Longo Prazo (12 meses)
- [ ] G√™meo digital completo (simula√ß√£o)
- [ ] Otimiza√ß√£o autom√°tica de bombas (economia energia)
- [ ] Integra√ß√£o com sistema financeiro (faturamento)
- [ ] Expans√£o para gest√£o de energia el√©trica

## Estrutura de Diret√≥rios

```
aguadaPy/
‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îú‚îÄ‚îÄ schema.sql              # Estrutura completa do BD
‚îÇ   ‚îú‚îÄ‚îÄ functions.sql           # PL/pgSQL (compress√£o, eventos)
‚îÇ   ‚îú‚îÄ‚îÄ triggers.sql            # Triggers autom√°ticos
‚îÇ   ‚îú‚îÄ‚îÄ seeds.sql               # Dados de exemplo
‚îÇ   ‚îî‚îÄ‚îÄ migrations/
‚îú‚îÄ‚îÄ firmware/
‚îÇ   ‚îú‚îÄ‚îÄ esp32_nivel/            # Sensor de n√≠vel
‚îÇ   ‚îú‚îÄ‚îÄ esp32_gateway/          # Gateway central
‚îÇ   ‚îî‚îÄ‚îÄ arduino_atuador/        # Controle de bombas/v√°lvulas
‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api/                # Endpoints REST
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/           # L√≥gica de neg√≥cio
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models/             # Models do BD
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ jobs/               # Relat√≥rio di√°rio, processamento
‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ tests/
‚îú‚îÄ‚îÄ frontend/
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/         # Componentes React/Vue
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pages/              # P√°ginas principais
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/           # API client
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils/              # Helpers
‚îÇ   ‚îî‚îÄ‚îÄ public/
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îú‚îÄ‚îÄ api.md                  # Documenta√ß√£o da API
‚îÇ   ‚îú‚îÄ‚îÄ manual_operacao.md      # Manual do operador
‚îÇ   ‚îî‚îÄ‚îÄ manual_tecnico.md       # Manual t√©cnico
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ backup.sh               # Backup autom√°tico BD
‚îÇ   ‚îú‚îÄ‚îÄ deploy.sh               # Deploy production
‚îÇ   ‚îî‚îÄ‚îÄ relatorio_diario.py     # Gera√ß√£o de relat√≥rio
‚îî‚îÄ‚îÄ README.md
```

## Contribuindo

Este √© um sistema em desenvolvimento cont√≠nuo. Sugest√µes de melhorias:
1. Abrir issue descrevendo o problema/melhoria
2. Fork do projeto
3. Criar branch com feature
4. Pull request com descri√ß√£o detalhada

## Licen√ßa

MIT License - uso livre para fins educacionais e comerciais

## Autores e Contato

**Sistema desenvolvido para gest√£o h√≠drica inteligente**

Documenta√ß√£o completa: `/docs`  
Issues: GitHub Issues  
Email: suporte@aguada.local

---

**Vers√£o**: 1.0.0  
**√öltima atualiza√ß√£o**: 2025-10-30  
**Status**: Em desenvolvimento ativo
